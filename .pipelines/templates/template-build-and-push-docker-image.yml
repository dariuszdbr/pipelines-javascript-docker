parameters:
  - name: containerRegistry
    type: string
  - name: servicePrincipalId
    type: string
  - name: servicePrincipalSecret
    type: string
  - name: imageRepository
    type: string
  - name: workingDirectory
    type: string

steps:
  - bash: |
      echo "Login using service principal ${{ parameters.servicePrincipalId }}"
      docker login ${{ parameters.containerRegistry }}.azurecr.io -u ${{ parameters.servicePrincipalId }} -p=$SP_SECRET
    displayName: Login to docker
    workingDirectory: ${{ parameters.workingDirectory }}
    env:
      SP_SECRET: ${{ parameters.servicePrincipalSecret }}
      
  - bash: |
      imageName=${{ parameters.containerRegistry }}.azurecr.io/${{ parameters.imageRepository }}:$(Build.BuildId)
      echo "##vso[task.setvariable variable=imageName]$imageName"     
      echo "Build $imageName"
      docker build -f Dockerfile -t $imageName .
    displayName: Build docker image
    workingDirectory: ${{ parameters.workingDirectory }}

  - bash: |
           docker push $imageName
    displayName: Publishing docker image
    workingDirectory: ${{ parameters.workingDirectory }}
    