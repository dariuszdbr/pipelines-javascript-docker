parameters:
  - name: containerRegistry
    type: string
  - name: servicePrincipalId
    type: string
  - name: servicePrincipalSecret
    type: string
  - name: imageRepository
    type: string
  - name: workingDirectory
    type: string

steps:
  - bash: |
      echo "Login using service principal ${{ parameters.servicePrincipalId }}"
      docker login ${{ parameters.containerRegistry }}.azurecr.io -u ${{ parameters.servicePrincipalId }} -p=$SP_SECRET
      imageName=${{ parameters.containerRegistry }}.azurecr.io/${{ parameters.imageRepository }}:$(Build.BuildId)
      echo "Build and push $imageName"
      docker build -f Dockerfile -t $imageName .
      docker push $imageName
    displayName: Build and publish docker image
    workingDirectory: ${{ parameters.workingDirectory }}
    env:
      SP_SECRET: ${{ parameters.servicePrincipalSecret }}
    